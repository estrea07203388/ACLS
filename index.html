<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACLSè¬›å¸«æ™‚æ•¸</title>
    <style>
        /* --- CSS (ç¾åŒ–å‡ç´š + ç§»é™¤é é¦–åœ–ç‰‡ + Emojiåœ–ç¤º) --- */
         @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes countUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes growBar { from { width: 0; } }
        @keyframes medal-pop { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes modal-fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background-color: #111827;
            background-image: linear-gradient(145deg, #1f2937, #111827);
            background-attachment: fixed;
            color: #e5e7eb;
            margin: 0;
            padding: 25px;
            overflow-x: hidden;
            line-height: 1.6;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(31, 41, 55, 0.75);
            backdrop-filter: blur(8px);
            padding: 35px; /* Use main padding */
            border-radius: 18px;
            box-shadow: 0 10px 35px rgba(0,0,0,0.35);
            border: 1px solid rgba(255, 255, 255, 0.08);
            animation: fadeIn 0.8s ease-out;
            position: relative;
            overflow: hidden; 
        }
         
         /* Loading Overlay Styles */
        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.95); display: flex; justify-content: center; align-items: center; z-index: 1001; border-radius: 18px; color: #9ca3af; font-size: 1.2em; text-align: center; padding: 20px; opacity: 1; transition: opacity 0.5s ease-out .2s; }
         #loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #60a5fa; animation: spin 1s ease infinite; margin-right: 15px; flex-shrink: 0; }
         .processing-spinner { display: inline-block; border: 2px solid rgba(255, 255, 255, 0.3); width: 16px; height: 16px; border-radius: 50%; border-left-color: #fff; animation: spin 0.8s ease infinite; margin-left: 8px; vertical-align: middle; }
         button:disabled, a.btn:disabled { cursor: not-allowed; opacity: 0.6; }

        h1 {
            text-align: center;
            font-size: 2.6em; 
            margin-bottom: 35px;
            background: linear-gradient(90deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
         }
        h2 { color: #a5b4fc; text-align: center; margin-bottom: 25px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 15px; font-size: 1.6em; margin-top: 0; }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 45px; justify-content: center; }
        .stat-card { background-color: rgba(55, 65, 81, 0.6); padding: 25px 20px; border-radius: 14px; text-align: center; transition: transform 0.3s ease, box-shadow 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 10px; border: 1px solid rgba(255, 255, 255, 0.08); }
        .stat-card:hover { transform: translateY(-6px); box-shadow: 0 12px 25px rgba(0,0,0,0.25); }
         /* --- Use Emoji for icon --- */
        .stat-card .icon-emoji { font-size: 2.5em; /* Larger emoji */ color: #60a5fa; margin-bottom: 12px; line-height: 1; }
        .stat-card .value { font-size: 2.9em; font-weight: 700; color: #f9fafb; letter-spacing: -1px; }
        .stat-card .label { font-size: 1.05em; color: #a1a1aa; }
        .chart-container { margin-bottom: 45px; padding: 30px; background: rgba(55, 65, 81, 0.6); border-radius: 14px; border: 1px solid rgba(255, 255, 255, 0.08); }
        .chart-bar { display: flex; align-items: center; margin-bottom: 14px; font-size: 14px; }
        .chart-label { width: 160px; text-align: right; padding-right: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #d1d5db; }
        .bar-container { flex-grow: 1; }
        .bar { height: 30px; background: linear-gradient(90deg, #60a5fa, #c4b5fd); border-radius: 6px; color: #1f2937; font-weight: 600; display: flex; align-items: center; justify-content: flex-end; padding-right: 12px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); animation: growBar 0.9s ease-out forwards; transform-origin: left; }
        .controls { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        #searchBox { flex-grow: 1; padding: 13px 18px; font-size: 16px; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 10px; background-color: rgba(55, 65, 81, 0.8); color: #f9fafb; min-width: 250px; transition: box-shadow 0.3s, border-color 0.3s; }
        #searchBox:focus { outline: none; border-color: #60a5fa; box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2); }
        .btn { padding: 13px 28px; font-size: 16px; border: none; border-radius: 10px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease; font-weight: 600; text-decoration: none; display: inline-block; text-align: center;}
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: linear-gradient(90deg, #38bdf8, #818cf8); color: white; }
        .btn-primary:hover { transform: scale(1.03); box-shadow: 0 6px 18px rgba(96, 165, 250, 0.3); }
        .btn-secondary { background: linear-gradient(90deg, #10b981, #34d399); color: white; }
        .btn-secondary:hover { transform: scale(1.03); box-shadow: 0 6px 18px rgba(16, 185, 129, 0.3); }
        .btn-link { background: #4b5563; color: white; font-size: 15px; padding: 13px 22px; }
        .btn-link:hover { background: #6b7280; transform: scale(1.03); box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2); }
        .filters { display: flex; gap: 12px; margin-bottom: 30px; flex-wrap: wrap; }
        .filter-btn { background-color: rgba(55, 65, 81, 0.8); color: #a1a1aa; padding: 9px 18px; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 25px; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; } /* Increased gap for emoji */
        .filter-btn.active { background-color: #60a5fa; color: #111827; font-weight: 600; border-color: #60a5fa; box-shadow: 0 3px 8px rgba(96, 165, 250, 0.2); }
         .filter-btn:hover:not(.active) { background-color: rgba(75, 85, 99, 0.9); color: #d1d5db; border-color: rgba(255, 255, 255, 0.2); }

        #table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.07); padding: 16px 18px; text-align: left; white-space: nowrap; vertical-align: middle; }
        th { background-color: rgba(55, 65, 81, 0.8); color: #cbd5e1; cursor: pointer; font-weight: 600; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 1;}
        th:first-child { border-top-left-radius: 10px; } th:last-child { border-top-right-radius: 10px; }
        th .sort-arrow { display: inline-block; width: 1em; text-align: center; opacity: 0.5; margin-left: 4px; vertical-align: middle;}
        th:not(.sorted-asc):not(.sorted-desc) .sort-arrow::before { content: 'â†•'; }
        th.sorted-asc .sort-arrow::before { content: 'â–²'; opacity: 1;}
        th.sorted-desc .sort-arrow::before { content: 'â–¼'; opacity: 1;}

        tr { transition: background-color 0.2s ease, transform 0.2s ease; }
        tr:hover { background-color: rgba(75, 85, 99, 0.7); transform: scale(1.005); }
        td { color: #d1d5db; }
        tr:last-child td { border-bottom: none; }
        tr:last-child td:first-child { border-bottom-left-radius: 10px; }
        tr:last-child td:last-child { border-bottom-right-radius: 10px; }
        .medal { margin-left: 8px; font-size: 1.2em; vertical-align: -0.1em; display: inline-block; animation: medal-pop 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        .action-buttons { display: flex; gap: 10px; }
        /* --- Style action buttons for Emojis --- */
        .action-buttons button { background: none; border: none; cursor: pointer; padding: 5px; opacity: 0.8; transition: opacity 0.2s, transform 0.2s; font-size: 1.25em; line-height: 1; }
        .action-buttons button:hover { opacity: 1; transform: scale(1.15); }
        .btn-edit:hover { /* color: #60a5fa; */ } /* Color is inherent to emoji */
        .btn-delete:hover { /* color: #fb7185; */ }
        
        .status-expired { color: #fb7185; font-weight: 600; }
        .status-expiring-soon { color: #fde047; font-weight: 600; }
        .status-manual-highlight { color: #fde047; font-weight: 600; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(17, 24, 39, 0.85); backdrop-filter: blur(6px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: rgba(31, 41, 55, 0.95); padding: 35px; border-radius: 18px; box-shadow: 0 10px 40px rgba(0,0,0,0.45); border: 1px solid rgba(255, 255, 255, 0.1); width: 90%; max-width: 500px; animation: modal-fade-in 0.4s ease-out; }
        .modal-content h3 { margin-top: 0; color: #a5b4fc; font-size: 1.6em; }
        .form-group { margin-bottom: 22px; }
        .form-group label { display: block; margin-bottom: 9px; color: #a1a1aa; font-size: 0.95em; }
        .form-group input { width: 100%; padding: 13px; font-size: 16px; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 10px; background-color: rgba(55, 65, 81, 0.8); color: #f9fafb; box-sizing: border-box; }
        .form-group input:focus { outline: none; border-color: #60a5fa; box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2); }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; }
        .btn-cancel { background-color: #4b5563; color: white; }
        #toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(23, 31, 44, 0.95); color: #e5e7eb; padding: 13px 28px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 5px 20px rgba(0, 0, 0, 0.35); z-index: 1002; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s ease, bottom 0.4s ease; font-size: 15px; }
        #toast-notification.show { opacity: 1; visibility: visible; bottom: 35px; }
        #toast-notification.success { border-left: 6px solid #10b981; }
        #toast-notification.error { border-left: 6px solid #f87171; }
    </style>
</head>
<body>

    <div class="container">
         <div id="loading-overlay">
            <div class="spinner"></div>
            <span>æ­£åœ¨å¾ Google Sheet è¼‰å…¥è³‡æ–™...</span>
        </div>
         
         <!-- Removed Header Banner Div -->

        <div class="main-content">
             <h1>ACLSè¬›å¸«æ™‚æ•¸</h1>

            <div class="stats-container">
                <!-- å„€è¡¨æ¿å¡ç‰‡æœƒå‹•æ…‹è¼‰å…¥ -->
            </div>

            <div class="chart-container">
                <h2>è¬›å¸«ç©åˆ†æ’å (Top 10)</h2>
                <div id="hours-chart" class="chart"></div>
            </div>

            <div class="controls">
                <input type="text" id="searchBox" placeholder="åœ¨é€™è£¡æœå°‹è¬›å¸«å§“åæˆ–ID...">
                <button id="add-instructor-btn" class="btn btn-primary">+ æ–°å¢è¬›å¸«</button>
                <button id="exportButton" class="btn btn-secondary">åŒ¯å‡ºæˆ Excel (CSV)</button>
                 <a href="instructor_query.html" class="btn btn-link">å‰å¾€è¬›å¸«æŸ¥è©¢</a>
            </div>
            <div class="filters">
                <button class="filter-btn active" data-filter="all">
                     ğŸ“‹ å…¨éƒ¨é¡¯ç¤º
                 </button>
                <button class="filter-btn" data-filter="expiring-soon">
                     âš ï¸ å³å°‡åˆ°æœŸ
                 </button>
                <button class="filter-btn" data-filter="expired">
                     ğŸš« è­‰æ›¸å·²éæœŸ
                 </button>
            </div>
            <div id="table-container">
                <table>
                    <thead>
                        <tr>
                            <th data-sort="TeacherID">æ•™å¸«ID <span class="sort-arrow"></span></th>
                            <th data-sort="TeacherName">æ•™å¸«å§“å <span class="sort-arrow"></span></th>
                            <th data-sort="TotalHours">æ•™å­¸ç©åˆ† <span class="sort-arrow"></span></th>
                            <th data-sort="CertDate">è­‰æ›¸æ•ˆæœŸ <span class="sort-arrow"></span></th>
                            <th data-sort="Title">è·ç¨± <span class="sort-arrow"></span></th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="admin-table-body">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div> {/* End main-content */}
    </div> {/* End container */}

     <!-- Modal HTML -->
    <div id="form-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">æ–°å¢è¬›å¸«</h3>
            <form id="instructor-form">
                <input type="hidden" id="edit-row-index">
                <div class="form-group">
                    <label for="teacher-id">æ•™å¸«ID</label>
                    <input type="number" id="teacher-id" required>
                </div>
                <div class="form-group">
                    <label for="teacher-name">æ•™å¸«å§“å</label>
                    <input type="text" id="teacher-name" required>
                </div>
                <div class="form-group">
                    <label for="teacher-title">è·ç¨±</label>
                    <input type="text" id="teacher-title" required>
                </div>
                <div class="form-group">
                    <label for="cert-date">è­‰æ›¸æ•ˆæœŸ (æ ¼å¼: 113.01.01-115.12.31)</label>
                    <input type="text" id="cert-date" placeholder="è‹¥ç„¡è«‹ç•™ç™½">
                </div>
                 <div class="form-group">
                     <label for="hours">æ•™å­¸ç©åˆ†</label>
                     <input type="number" id="hours" placeholder="è«‹è¼¸å…¥æ•¸å­—ï¼Œé è¨­ç‚º 0" value="0">
                 </div>
                <div class="modal-buttons">
                    <button type="button" id="cancel-btn" class="btn btn-cancel">å–æ¶ˆ</button>
                    <button type="submit" id="save-btn" class="btn btn-primary">å„²å­˜<span id="save-spinner" class="processing-spinner" style="display: none;"></span></button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification"></div>


    <script>
    // --- JavaScript ---
    const GAS_URL = 'https://script.google.com/macros/s/AKfycby3yFoQDJ9LMNxHOu9tJ3ySMFDcp5zgbgnUySIdaA_Fjkkuq5nJzcgG2BsENOmrRsWI/exec';
    let combinedData = [];
    let currentSort = { column: 'TeacherID', direction: 'asc' };
    let currentFilter = 'all';

    // Helper functions
     const convertToAD = (rocDateStr) => { /* ... */
        if (!rocDateStr || !rocDateStr.includes('.')) return null;
        const parts = rocDateStr.split('.').map(Number);
        if (parts.length !== 3) return null;
        if (parts[0] < 90 || parts[1] < 1 || parts[1] > 12 || parts[2] < 1 || parts[2] > 31) {
             console.warn(`Invalid ROC date format detected: ${rocDateStr}`); return null;
         }
        try { return new Date(parts[0] + 1911, parts[1] - 1, parts[2]); }
        catch (e) { console.error(`Error converting ROC date: ${rocDateStr}`, e); return null; }
    };
     const getCertStatus = (certDateStr) => { /* ... */
        if (!certDateStr || !certDateStr.includes('-') || certDateStr.toLowerCase() === 'ç„¡ç´€éŒ„') { return { status: '', endDate: null }; }
        const dateParts = certDateStr.split('-');
        if (dateParts.length !== 2) return { status: '', endDate: null };
        const endDateStr = dateParts[1].trim();
        const endDate = convertToAD(endDateStr);
        if (!endDate || isNaN(endDate.getTime())) { console.warn(`Could not parse end date from: ${certDateStr}`); return { status: '', endDate: null }; }
        const today = new Date(); today.setHours(0, 0, 0, 0);
        const oneYearFromNow = new Date(today); oneYearFromNow.setFullYear(today.getFullYear() + 1);
        let status = '';
        const endDateTime = new Date(endDate); endDateTime.setHours(0,0,0,0);
        if (endDateTime < today) { status = 'status-expired'; }
        else if (endDateTime <= oneYearFromNow) { status = 'status-expiring-soon'; }
        if (certDateStr.includes('113.11.10-115.11.09') || certDateStr.includes('114.05.13-116.05.12')) {
             status = `${status} status-manual-highlight`.trim();
        }
        return { status, endDate: endDateTime };
    };
     const animateValue = (obj, start, end, duration) => { /* ... */
        if (!obj) return; let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    };
    const toast = document.getElementById('toast-notification');
    let toastTimeout;
    function showToast(message, type = 'info', duration = 3000) { /* ... */
        if (!toast) return;
        toast.textContent = message;
        toast.className = '';
        if (type === 'success') toast.classList.add('success');
        if (type === 'error') toast.classList.add('error');
        toast.classList.add('show');
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, duration);
    }

    // Data Fetching
    async function fetchDataFromGAS() { /* ... same as before ... */
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.classList.remove('hidden');
        loadingOverlay.innerHTML = `<div class="spinner"></div><span>æ­£åœ¨å¾ Google Sheet è¼‰å…¥è³‡æ–™...</span>`;
        try {
            const response = await fetch(GAS_URL);
            if (!response.ok) { let errorMsg = `ç„¡æ³•è®€å–è³‡æ–™ (HTTP ${response.status})`; try { const errorJson = await response.json(); if (errorJson && errorJson.error) { errorMsg = errorJson.error; } } catch (e) { errorMsg = `${errorMsg} - ${response.statusText}`; } throw new Error(errorMsg); }
            const result = await response.json();
            if (result.error) { throw new Error(result.error); }
            if (!result.data || !Array.isArray(result.data)) { throw new Error("å¾ Google Apps Script æ”¶åˆ°çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºã€‚"); }
            combinedData = result.data.map(teacher => { if (teacher.TeacherID === undefined || teacher.TeacherName === undefined) { console.warn("Missing data:", teacher); return null; } const { status, endDate } = getCertStatus(teacher.CertDate); let finalStatus = status; if (teacher.TeacherID === 1218 || teacher.TeacherID === 385) { finalStatus = `${status} status-manual-highlight`.trim(); } return { ...teacher, TotalHours: teacher.Hours, certStatus: finalStatus, certEndDate: endDate, rowIndex: teacher.rowIndex }; }).filter(item => item !== null);
            console.log("è³‡æ–™æˆåŠŸè¼‰å…¥:", combinedData.length, "ç­†è¨˜éŒ„");
            refreshUI();
        } catch (error) { console.error('GAS Error:', error); const userFriendlyError = `ç„¡æ³•è¼‰å…¥ Google Sheet è³‡æ–™ï¼Œè«‹æª¢æŸ¥ï¼š\n1. Apps Script éƒ¨ç½²èˆ‡æ¬Šé™ã€‚\n2. Sheet æ¨™é¡Œèˆ‡åˆ†äº«è¨­å®šã€‚\n3. ç¶²è·¯é€£ç·šã€‚\n\néŒ¯èª¤: ${error.message}`; alert(userFriendlyError); loadingOverlay.innerHTML = `<span>è®€å–å¤±æ•—ï¼š<br>${userFriendlyError.replace(/\n/g, '<br>')}</span>`; } finally { setTimeout(() => { const loadingText = loadingOverlay.textContent || ""; if (!loadingText.includes('å¤±æ•—')) { loadingOverlay.classList.add('hidden'); } }, 500); }
    }


    // UI Rendering
    const renderDashboardStats = (data) => {
        const statsContainer = document.querySelector('.stats-container'); if (!statsContainer) return; statsContainer.innerHTML = '';
        // --- Use Emoji Icons ---
        const totalInstructorsCard = document.createElement('div'); totalInstructorsCard.className = 'stat-card';
        totalInstructorsCard.innerHTML = `<div class="icon-emoji">ğŸ‘¥</div><div id="total-instructors-value" class="value">0</div><div class="label">ç¸½è¬›å¸«äººæ•¸</div>`;
        statsContainer.appendChild(totalInstructorsCard);
        
        const expiringCard = document.createElement('div'); expiringCard.className = 'stat-card';
        expiringCard.innerHTML = `<div class="icon-emoji">ğŸ“…</div><div id="expiring-this-month-value" class="value">0</div><div class="label">æœ¬æœˆåˆ°æœŸè­‰æ›¸æ•¸</div>`;
        statsContainer.appendChild(expiringCard);

        const totalInstructors = data.length; const today = new Date(); const currentMonth = today.getMonth(); const currentYear = today.getFullYear(); const expiringThisMonth = data.filter(t => t.certEndDate && t.certEndDate.getMonth() === currentMonth && t.certEndDate.getFullYear() === currentYear && !t.certStatus.includes('status-expired')).length;
        const totalInstructorsValueEl = document.getElementById('total-instructors-value'); const expiringThisMonthValueEl = document.getElementById('expiring-this-month-value');
        if (totalInstructorsValueEl) animateValue(totalInstructorsValueEl, 0, totalInstructors, 1000); if (expiringThisMonthValueEl) animateValue(expiringThisMonthValueEl, 0, expiringThisMonth, 1000);
     };
    const renderHoursChart = (data) => { /* ... same as before ... */
        const chartContainer = document.getElementById('hours-chart'); if (!chartContainer) return; const sortedByHours = [...data].sort((a, b) => (b.TotalHours || 0) - (a.TotalHours || 0)); const top10 = sortedByHours.slice(0, 10).filter(t => t.TotalHours > 0); const maxHours = top10.length > 0 ? (top10[0].TotalHours || 1) : 1; let chartHtml = ''; if (top10.length > 0) { top10.forEach(teacher => { const currentHours = teacher.TotalHours || 0; const barWidth = Math.max(0, Math.min(100, (currentHours / maxHours) * 100)); const safeName = (teacher.TeacherName || 'N/A').replace(/</g, "&lt;").replace(/>/g, "&gt;"); chartHtml += `<div class="chart-bar"><div class="chart-label" title="${safeName}">${safeName}</div><div class="bar-container"><div class="bar" style="width: ${barWidth}%;">${currentHours}</div></div></div>`; }); } else { chartHtml = '<p style="text-align:center; color: #9ca3af;">å°šç„¡æ•™å­¸ç©åˆ†ç´€éŒ„å¯ä¾›æ’åã€‚</p>'; } chartContainer.innerHTML = chartHtml;
     };
    const renderTable = (data, topThreeIds) => {
        const tableBody = document.getElementById('admin-table-body'); if (!tableBody) return;
        tableBody.innerHTML = data.map(teacher => {
             if (!teacher || teacher.TeacherID === undefined) return ''; let medal = ''; const rank = topThreeIds.indexOf(teacher.TeacherID); if (teacher.TotalHours > 0 && rank !== -1) { if (rank === 0) medal = `<span class="medal" title="ç©åˆ†ç¬¬ä¸€å">ğŸ¥‡</span>`; else if (rank === 1) medal = `<span class="medal" title="ç©åˆ†ç¬¬äºŒå">ğŸ¥ˆ</span>`; else if (rank === 2) medal = `<span class="medal" title="ç©åˆ†ç¬¬ä¸‰å">ğŸ¥‰</span>`; } const safeName = (teacher.TeacherName || '').replace(/</g, "&lt;").replace(/>/g, "&gt;"); const safeTitle = (teacher.Title || '').replace(/</g, "&lt;").replace(/>/g, "&gt;"); const safeCertDate = (teacher.CertDate || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
            // --- Use Emojis for buttons ---
            const editEmoji = 'âœï¸';
            const deleteEmoji = 'ğŸ—‘ï¸';

            return `<tr data-row-index="${teacher.rowIndex}" data-id="${teacher.TeacherID}"><td>${teacher.TeacherID}</td> <td>${safeName} ${medal}</td> <td>${teacher.TotalHours || 0}</td><td class="${teacher.certStatus || ''}">${safeCertDate}</td> <td>${safeTitle}</td><td class="action-buttons"><button class="btn-edit" title="ç·¨è¼¯">${editEmoji}</button><button class="btn-delete" title="åˆªé™¤">${deleteEmoji}</button></td></tr>`;
        }).join('');
    };

    // Main Refresh
    function refreshUI() { /* ... same filtering and sorting logic as before ... */
        if (!combinedData) return; const dataForProcessing = Array.isArray(combinedData) ? combinedData : []; const sortedByHoursAll = [...dataForProcessing].sort((a, b) => (b.TotalHours || 0) - (a.TotalHours || 0)); const topThreeIds = sortedByHoursAll.slice(0, 3).map(t => t.TeacherID); let filteredData = dataForProcessing; const searchBox = document.getElementById('searchBox'); const searchQuery = searchBox ? searchBox.value.toLowerCase() : ''; if (searchQuery) { filteredData = filteredData.filter(t => (t.TeacherID && String(t.TeacherID).includes(searchQuery)) || (t.TeacherName && t.TeacherName.toLowerCase().includes(searchQuery)) || (t.Title && t.Title.toLowerCase().includes(searchQuery)) ); } if (currentFilter !== 'all') { filteredData = filteredData.filter(t => { let s = t.certStatus || ''; if (currentFilter === 'expired') return s.includes('status-expired'); else if (currentFilter === 'expiring-soon') return s.includes('status-expiring-soon') || (s.includes('status-manual-highlight') && !s.includes('status-expired')); return false; }); } const sortKey = currentSort.column; const direction = currentSort.direction === 'asc' ? 1 : -1; const sortedFilteredData = [...filteredData].sort((a, b) => { let valA = a[sortKey], valB = b[sortKey]; if (sortKey === 'CertDate') { valA = a.certEndDate; valB = b.certEndDate; const aIsValid = valA instanceof Date && !isNaN(valA); const bIsValid = valB instanceof Date && !isNaN(valB); if (!aIsValid && !bIsValid) return 0; if (!aIsValid) return 1; if (!bIsValid) return -1; if (valA < valB) return -1 * direction; if (valA > valB) return 1 * direction; return 0; } else if (typeof valA === 'string' && typeof valB === 'string') { return valA.localeCompare(valB, 'zh-Hant') * direction; } else { valA = (valA === null || valA === undefined) ? (direction === 1 ? Infinity : -Infinity) : Number(valA); valB = (valB === null || valB === undefined) ? (direction === 1 ? Infinity : -Infinity) : Number(valB); if (isNaN(valA) && isNaN(valB)) return 0; if (isNaN(valA)) return 1; if (isNaN(valB)) return -1; if (valA < valB) return -1 * direction; if (valA > valB) return 1 * direction; return 0; } });
        renderDashboardStats(dataForProcessing); renderHoursChart(dataForProcessing); renderTable(sortedFilteredData, topThreeIds);
    }

    // Modal Management
    const modal = document.getElementById('form-modal'); const form = document.getElementById('instructor-form'); const modalTitle = document.getElementById('modal-title'); const editRowIndexInput = document.getElementById('edit-row-index'); const teacherIdInput = document.getElementById('teacher-id'); const saveBtn = document.getElementById('save-btn'); const saveSpinner = document.getElementById('save-spinner');
    const openModal = (mode, teacher = null) => { /* ... same as before ... */ if (!form) return; form.reset(); const hoursInput = document.getElementById('hours'); if (hoursInput) hoursInput.value = 0; if (mode === 'edit' && teacher) { if (modalTitle) modalTitle.textContent = 'ç·¨è¼¯è¬›å¸«è³‡æ–™'; if (editRowIndexInput) editRowIndexInput.value = teacher.rowIndex; if (teacherIdInput) { teacherIdInput.value = teacher.TeacherID; teacherIdInput.disabled = true; } const teacherNameInput = document.getElementById('teacher-name'); if (teacherNameInput) teacherNameInput.value = teacher.TeacherName || ''; const teacherTitleInput = document.getElementById('teacher-title'); if (teacherTitleInput) teacherTitleInput.value = teacher.Title || ''; const certDateInput = document.getElementById('cert-date'); if (certDateInput) certDateInput.value = teacher.CertDate !== 'ç„¡ç´€éŒ„' ? teacher.CertDate : ''; if (hoursInput) hoursInput.value = teacher.TotalHours || 0; } else { if (modalTitle) modalTitle.textContent = 'æ–°å¢è¬›å¸«'; if (editRowIndexInput) editRowIndexInput.value = ''; if (teacherIdInput) teacherIdInput.disabled = false; } if (saveBtn) saveBtn.disabled = false; if (saveSpinner) saveSpinner.style.display = 'none'; if (modal) modal.style.display = 'flex'; };
    const closeModal = () => { /* ... same as before ... */ if (modal) modal.style.display = 'none'; };

    // API Call
    async function callGAS(action, data, rowIndex = null) { /* ... same as before ... */ if (saveBtn) saveBtn.disabled = true; if (saveSpinner) saveSpinner.style.display = 'inline-block'; const loadingOverlay = document.getElementById('loading-overlay'); loadingOverlay.classList.remove('hidden'); loadingOverlay.innerHTML = `<div class="spinner"></div><span>è™•ç†ä¸­...</span>`; const payload = { action, data }; if (rowIndex !== null) { payload.rowIndex = rowIndex; } try { await new Promise(resolve => setTimeout(resolve, 100)); const response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }); if (!response.ok) { let errorDetail = `HTTP ç‹€æ…‹: ${response.status}`; try { const errorText = await response.text(); errorDetail = errorText || errorDetail; if (!errorText || errorText.startsWith('<!DOCTYPE html>')) { try { const errorJson = JSON.parse(errorText); if (errorJson && errorJson.message) errorDetail = errorJson.message; } catch (jsonError) { console.warn("Cannot parse error response as JSON:", jsonError); } } } catch (parseError) { console.error("Error handling error response:", parseError); } throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${errorDetail}`); } const result = await response.json(); console.log("GAS Response:", result); if (result.status === 'success') { showToast(result.message || 'æ“ä½œæˆåŠŸï¼', 'success'); closeModal(); await fetchDataFromGAS(); } else { throw new Error(result.message || 'Apps Script returned failure status without details.'); } } catch (error) { console.error(`Error performing action "${action}":`, error); showToast(`æ“ä½œå¤±æ•—: ${error.message}`, 'error', 5000); loadingOverlay.innerHTML = `<span>æ“ä½œå¤±æ•—ï¼š<br>${error.message.replace(/\n/g, '<br>')}</span>`; } finally { if (saveBtn) saveBtn.disabled = false; if (saveSpinner) saveSpinner.style.display = 'none'; const loadingText = loadingOverlay.textContent || ""; if (loadingText.includes('è™•ç†ä¸­') || !loadingText.includes('å¤±æ•—')) { setTimeout(() => loadingOverlay.classList.add('hidden'), 300); } } }

    // Event Listeners
    /* ... all event listeners are the same as before ... */
     const addBtn = document.getElementById('add-instructor-btn'); if (addBtn) { addBtn.addEventListener('click', () => openModal('add')); }
    const cancelBtn = document.getElementById('cancel-btn'); if (cancelBtn) { cancelBtn.addEventListener('click', closeModal); }
    if (modal) { modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); }); }
    if (form) { form.addEventListener('submit', async (e) => { e.preventDefault(); const editingRowIndex = editRowIndexInput && editRowIndexInput.value ? parseInt(editRowIndexInput.value) : null; const hoursValue = document.getElementById('hours') ? parseInt(document.getElementById('hours').value) : 0; const instructorData = { TeacherID: teacherIdInput ? parseInt(teacherIdInput.value) : null, TeacherName: document.getElementById('teacher-name') ? document.getElementById('teacher-name').value.trim() : '', Title: document.getElementById('teacher-title') ? document.getElementById('teacher-title').value.trim() : '', CertDate: document.getElementById('cert-date') ? document.getElementById('cert-date').value.trim() : '', Hours: isNaN(hoursValue) ? 0 : hoursValue }; if (instructorData.TeacherID === null || isNaN(instructorData.TeacherID) || !instructorData.TeacherName) { showToast("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•™å¸« ID å’Œå§“åã€‚", "error"); return; } if (editingRowIndex) { const updateData = { TeacherName: instructorData.TeacherName, Title: instructorData.Title, CertDate: instructorData.CertDate, Hours: instructorData.Hours }; await callGAS('updateInstructor', updateData, editingRowIndex); } else { await callGAS('addInstructor', instructorData); } }); }
    const tableBodyEl = document.getElementById('admin-table-body'); if (tableBodyEl) { tableBodyEl.addEventListener('click', async (e) => { const editBtn = e.target.closest('.btn-edit'); const deleteBtn = e.target.closest('.btn-delete'); if (editBtn) { const row = editBtn.closest('tr'); const rowIndex = parseInt(row.dataset.rowIndex); const teacherToEdit = combinedData.find(t => t.rowIndex === rowIndex); if (teacherToEdit) { openModal('edit', teacherToEdit); } else { console.error("Cannot find instructor data for editing, rowIndex:", rowIndex); showToast("æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„è¬›å¸«è³‡æ–™ã€‚", "error"); } } if (deleteBtn) { const row = deleteBtn.closest('tr'); const rowIndex = parseInt(row.dataset.rowIndex); const teacherToDelete = combinedData.find(t => t.rowIndex === rowIndex); const teacherName = teacherToDelete ? teacherToDelete.TeacherName : `åˆ— ${rowIndex}`; if (confirm(`æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ${teacherName}ã€çš„è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œå°‡ç›´æ¥ä¿®æ”¹ Google Sheet ä¸”ç„¡æ³•å¾©åŸã€‚`)) { await callGAS('deleteInstructor', null, rowIndex); } } }); }
    const searchBoxEl = document.getElementById('searchBox'); if (searchBoxEl) { searchBoxEl.addEventListener('input', refreshUI); }
    const filtersEl = document.querySelector('.filters'); if (filtersEl) { filtersEl.addEventListener('click', (e) => { if (e.target.classList.contains('filter-btn')) { document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); currentFilter = e.target.dataset.filter; refreshUI(); } }); }
    const tableHeadEl = document.querySelector('thead'); if (tableHeadEl) { tableHeadEl.addEventListener('click', (e) => { const header = e.target.closest('th'); if (!header || !header.dataset.sort) return; const sortKey = header.dataset.sort; const direction = (currentSort.column === sortKey && currentSort.direction === 'asc') ? 'desc' : 'asc'; currentSort = { column: sortKey, direction }; document.querySelectorAll('thead th').forEach(th => th.classList.remove('sorted-asc', 'sorted-desc')); header.classList.add(direction === 'asc' ? 'sorted-asc' : 'sorted-desc'); refreshUI(); }); }
    const exportButtonEl = document.getElementById('exportButton'); if (exportButtonEl) { exportButtonEl.addEventListener('click', function() { const dataToExport = combinedData; if (!Array.isArray(dataToExport) || dataToExport.length === 0) { showToast("æ²’æœ‰è³‡æ–™å¯ä¾›åŒ¯å‡ºã€‚", "error"); return; } let csv = ['"æ•™å¸«ID","æ•™å¸«å§“å","æ•™å­¸ç©åˆ†","è­‰æ›¸æ•ˆæœŸ","è·ç¨±"']; dataToExport.forEach(t => { const id = t.TeacherID ?? ''; const name = t.TeacherName ?? ''; const hours = t.TotalHours ?? 0; const cert = t.CertDate ?? ''; const title = t.Title ?? ''; const escapeCSV = (field) => `"${String(field).replace(/"/g, '""')}"`; csv.push([escapeCSV(id), escapeCSV(name), escapeCSV(hours), escapeCSV(cert), escapeCSV(title)].join(',')); }); const csvContent = '\uFEFF' + csv.join('\n'); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", "è¬›å¸«ç©åˆ†ç¸½è¡¨.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); }); }

    // Initial Load
    window.onload = function() {
        const statsContainer = document.querySelector('.stats-container');
        if (statsContainer) {
             statsContainer.innerHTML = `
                 <div class="stat-card">
                     <div class="icon-emoji">ğŸ‘¥</div>
                     <div id="total-instructors-value" class="value">0</div>
                     <div class="label">ç¸½è¬›å¸«äººæ•¸</div>
                 </div>
                 <div class="stat-card">
                     <div class="icon-emoji">ğŸ“…</div>
                     <div id="expiring-this-month-value" class="value">0</div>
                     <div class="label">æœ¬æœˆåˆ°æœŸè­‰æ›¸æ•¸</div>
                 </div>
             `;
        }
        fetchDataFromGAS(); // Fetch data using GAS on load
     };
    </script>

</body>
</html>

